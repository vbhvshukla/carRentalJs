<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Bookings</title>
    <link rel="stylesheet" href="/styles/index.css">
</head>

<body>
    <div class="wrap">
        <div class="header">
            <div class="logo">
                <img src="../assets/images/logo.png" alt="Logo">
            </div>
            <nav class="nav-links">
                <a href="#" id="about-us-link">About Us</a>
                <a href="#" id="contact-us-link">Contact Us</a>
                <a href="./mybiddings.html" id="my-biddings-link">My Biddings</a>
                <a href="./login.html" id="login-signup-link">Login</a>
                <a href="#" id="logout-link">Logout</a>
            </nav>
        </div>

        <div class="main">
            <div class="sidebar">
                <h3>Owner Dashboard</h3>
                <ul>
                    <li><a href="./odashboard.html">Dashboard</a></li>
                    <li><a href="./add-car.html">Add New Car</a></li>
                    <li><a href="./view-bookings.html">View Bookings</a></li>
                </ul>
            </div>

            <div class="content">
                <h2>Your Bookings</h2>
                <div id="bookings-container" class="bookings-container"></div>
            </div>
        </div>

        <div class="footer">
            Footer
        </div>
    </div>

    <script type="module">
        import { getAllItemsByIndex, getItemByKey, updateItem } from "../js/utils/dbUtils.js";
        import { checkAuth, logout } from "../js/utils/auth.js";
        import { getCookie } from "../js/utils/cookie.js";

        const userId = getCookie("userId");
        const role = getCookie("role");

        async function updateNavLinks() {
            const isAuthenticated = await checkAuth();
            const myBiddingsLink = document.getElementById('my-biddings-link');
            const loginSignupLink = document.getElementById('login-signup-link');
            const logoutLink = document.getElementById('logout-link');

            if (isAuthenticated) {
                myBiddingsLink.style.display = 'block';
                loginSignupLink.style.display = 'none';
                logoutLink.style.display = 'block';
            } else {
                myBiddingsLink.style.display = 'none';
                loginSignupLink.style.display = 'block';
                logoutLink.style.display = 'none';
            }
        }

        async function getBookings() {
            try {
                const ownerId = getCookie("userId");
                const ownerBookings = await getAllItemsByIndex("bookings", "ownerId", ownerId);
                return ownerBookings;
            } catch (error) {
                console.error("Error fetching bookings:", error);
                return [];
            }
        }

        function createBookingCard(booking) {
            const card = document.createElement("div");
            card.className = "car-card";
            const bookingDetails = `
                <div class="car-details">
                    <h3 class="car-name">${booking.carName}</h3>
                    <div class="car-features">
                        <span class="feature">Bid Price: $${booking.bidPrice}</span>
                    </div>
                    <div class="car-rating">
                        <span class="stars">From: ${booking.from}</span>
                        <span class="rating-count">To: ${booking.to}</span>
                    </div>
                    <div class="car-price-city">
                        <span class="price">User: ${booking.username}</span>
                        <span class="city">Created At: ${new Date(booking.createdAt).toLocaleDateString()}</span>
                        <span class="status">${booking.isValid ? 'Active' : 'Cancelled'}</span>
                    </div>
                    ${booking.isValid ? '<button class="cancel-booking-btn">Cancel Booking</button>' : ''}
                </div>
            `;
            card.innerHTML = bookingDetails;

            if (booking.isValid) {
                const cancelBookingButton = card.querySelector(".cancel-booking-btn");
                cancelBookingButton.addEventListener("click", () => cancelBooking(booking.bookingId));
            }

            return card;
        }

        async function renderBookings() {
            const bookings = await getBookings();
            const bookingsContainer = document.getElementById("bookings-container");
            bookingsContainer.innerHTML = "";
            if (bookings.length === 0) {
                bookingsContainer.innerHTML = "<p>No bookings found.</p>";
                return;
            }
            bookings.forEach((booking) => {
                const card = createBookingCard(booking);
                bookingsContainer.appendChild(card);
            });
        }

        async function cancelBooking(bookingId) {
            try {
                const booking = await getItemByKey("bookings", bookingId);
                booking.isValid = false;
                await updateItem("bookings", booking);
                alert(`Cancelled booking with ID: ${bookingId}`);
                renderBookings();
            } catch (error) {
                console.error(`Error cancelling booking with ID: ${bookingId}`, error);
                alert('Failed to cancel booking. Please try again.');
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            if(checkAuth && userId && role=='owner'){
                renderBookings();
                updateNavLinks();
                document.getElementById('logout-link').addEventListener('click', (event) => {
                    event.preventDefault();
                    logout();
                });

            }
            else {
                window.location.href="./index.html";
            }
        });
    
    </script>
</body>

</html>