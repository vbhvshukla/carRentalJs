<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental - Booking</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        .wrap {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background-color: #0d7963;
            color: #fff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header .logo img {
            height: 60px;
        }

        .nav-links {
            display: flex;
            gap: 20px;
        }

        .nav-links a {
            color: #fff;
            text-decoration: none;
            font-size: 16px;
        }

        .main {
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            margin-top: 20px;
        }

        .car-details {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex: 0 0 60%;
        }

        .car-details h3 {
            margin-bottom: 15px;
            font-size: 20px;
        }

        .bid-form {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            flex: 0 0 35%;
            margin-left: 20px;
        }

        .footer {
            text-align: center;
            background-color: #0d7963;
            color: #fff;
            padding: 15px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }

        button {
            background-color: #007bff;
            color: #fff;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        input[type="date"],
        input[type="number"] {
            padding: 10px;
            width: 100%;
            margin: 5px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .price-info {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .footer p {
            margin: 0;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .main {
                flex-direction: column;
            }

            .car-details,
            .bid-form {
                width: 100%;
                margin: 0;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <header class="header">
            <div class="logo">
                <img src="../assets/images/logo.png" alt="Logo">
            </div>
            <nav class="nav-links">
                <a href="/">Home</a>
                <a href="#">About Us</a>
                <a href="#">Contact Us</a>
                <a href="/views/login.html">Login</a>
            </nav>
        </header>

        <div class="main">
            <div class="car-details">
                <h3 id="car-name"></h3>
                <p><strong>Price:</strong> $<span id="base-price"></span>/day</p>
                <p><strong>Description:</strong> <span id="car-description"></span></p>
                <p><strong>Owner:</strong> <span id="owner-name"></span></p>
                <p><strong>City:</strong> <span id="car-city"></span></p>
                <p><strong>Category:</strong> <span id="category-name"></span></p>
                <p><strong>Featured:</strong> <span id="featured"></span></p>
                <div id="car-images"></div>
            </div>

            <div class="bid-form">
                <h3>Place Your Bid</h3>
                <label for="start-date">Start Date</label>
                <input type="date" id="start-date" required>
                <label for="end-date">End Date</label>
                <input type="date" id="end-date" required>
                <div class="price-info">
                    <strong>Current Price:</strong> $<span id="current-price"></span>/day
                </div>
                <label for="bid-amount">Your Bid</label>
                <input type="number" id="bid-amount" placeholder="Enter your bid" min="1" required>
                <button id="submit-bid">Submit Bid</button>
            </div>
        </div>

        <div class="footer">
            Footer
        </div>
    </div>

    <script type="module">
        import { getItemByKey, getAllItems, addItem } from "../js/utils/dbUtils.js";
        import { generateRandomId } from "../js/utils/generateId.js";
        import { getCookie } from "../js/utils/cookie.js";

        const userId = getCookie("userId");
        const username = getCookie("username");

        function getCarIdFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('carId');
        }

        async function renderCarDetails() {
            const carId = getCarIdFromURL();
            if (!carId) {
                alert("Car not found.");
                return;
            }

            try {
                const car = await getItemByKey("cars", carId);
                if (!car) {
                    alert("Car not found in the database.");
                    return;
                }

                const carImagesContainer = document.getElementById("car-images");
                car.images.forEach(image => {
                    const img = document.createElement("img");
                    img.src = image;
                    img.alt = "Car Image";
                    carImagesContainer.appendChild(img);
                });


                document.getElementById("car-name").innerText = car.carName;
                document.getElementById("base-price").innerText = car.basePrice;
                document.getElementById("car-description").innerText = car.description;
                document.getElementById("owner-name").innerText = car.ownerName;
                document.getElementById("car-city").innerText = car.city;
                document.getElementById("category-name").innerText = car.categoryName;
                document.getElementById("featured").innerText = car.featured.join(", ");

                const priceElement = document.getElementById("current-price");
                priceElement.innerText = car.basePrice;

                document.getElementById("submit-bid").addEventListener("click", async () => {
                    const startDate = document.getElementById("start-date").value;
                    const endDate = document.getElementById("end-date").value;
                    const bidAmount = parseFloat(document.getElementById("bid-amount").value);

                    if (!startDate || !endDate || !bidAmount) {
                        alert("Please fill in all the fields.");
                        return;
                    }

                    if (new Date(startDate) > new Date(endDate)) {
                        alert("End Date can't be before start date!");
                        return;
                    }

                    const allBids = await getAllItems("bids");
                    const validBids = allBids.filter(bid => {
                        return bid.carId === carId &&
                            ((new Date(bid.from) >= new Date(startDate) && new Date(bid.from) <= new Date(endDate)) ||
                                (new Date(bid.to) >= new Date(startDate) && new Date(bid.to) <= new Date(endDate)));
                    });

                    const highestBid = validBids.reduce((max, bid) => bid.bidAmount > max ? bid.bidAmount : max, car.basePrice);

                    if (bidAmount >= highestBid) {
                        const newBid = {
                            bidId: generateRandomId(),
                            carId: carId,
                            carName: car.carName,
                            bidAmount: bidAmount,
                            from: startDate,
                            to: endDate,
                            userId: userId,
                            username: username,
                            ownerId: car.ownerId,
                            createdAt: new Date().toISOString(),
                            status: "Pending"
                        };

                        await addItem("bids", newBid);
                        alert("Your bid has been placed successfully.");
                    } else {
                        alert("Your bid is lower than the current highest bid.");
                    }
                });

            } catch (error) {
                console.error("Error fetching car details:", error);
            }
        }

        document.addEventListener("DOMContentLoaded", renderCarDetails);
    </script>
</body>

</html>