<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Car Rental</title>
    <link rel="stylesheet" href="/styles/index.css">
    <link rel="stylesheet" href="/styles/card.css">
</head>

<body>
    <div class="wrap">
        <div class="header">
            <div class="logo">
                <img src="../assets/images/logo.png" alt="Logo">
            </div>
            <nav class="nav-links">
                <a href="#">About Us</a>
                <a href="#">Contact Us</a>
                <a href="/views/login.html">Login/Signup</a>
            </nav>
        </div>

        <div class="main">
            <div class="sidebar">
                Lorem ipsum dolor, sit amet consectetur adipisicing elit. Voluptatibus tempora, ea veniam assumenda
                exercitationem vel, iure eligendi saepe rem perferendis provident obcaecati necessitatibus vero dolore,
                aperiam quod molestiae inventore amet.
            </div>

            <div class="content">
                <div id="cars-container" class="cars-container"></div>
            </div>
        </div>

        <div class="footer">
            Footer
        </div>
    </div>

    <script type="module">
        import { getAllItems } from "../js/utils/dbUtils.js";

        async function getCars() {
            try {
                return await getAllItems("cars");
            } catch (error) {
                console.error("Error fetching cars:", error);
                return [];
            }
        }

        function generateStarRating(avgRating) {
            const fullStars = Math.floor(avgRating);
            const halfStar = avgRating % 1 >= 0.5 ? 1 : 0;
            const emptyStars = 5 - fullStars - halfStar;

            return (
                "★".repeat(fullStars) +
                "½".repeat(halfStar) +
                "☆".repeat(emptyStars)
            );
        }

        function redirectToBookingPage(carId) {
            window.location.href = `/views/booking.html?carId=${carId}`;
        }

        function createCarCard(car) {
            const card = document.createElement("div");
            card.className = "car-card";
            const carousel = `
                                <div class="carousel">
                                    <div class="carousel-images">
                                        ${car.images
                                            .map(
                                                (image, index) =>
                                                    `<img src="${image}" alt="Car Image ${index + 1}" class="carousel-image ${index === 0 ? "active" : ""}">`
                                            )
                                            .join("")}
                                    </div>
                                    <button class="carousel-button prev" onclick="prevImage(this)">&#10094;</button>
                                    <button class="carousel-button next" onclick="nextImage(this)">&#10095;</button>
                                </div>
                            `;

            const carDetails = `
                                <div class="car-details">
                                    <h3 class="car-name">${car.carName}</h3>
                                        <div class="car-features">
                                            ${car.featured.map((feature) => `<span class="feature">${feature}</span>`).join("")}
                                        </div>
                                <div class="car-rating">
                                    <span class="stars">${generateStarRating(car.avgRating)}</span>
                                    <span class="rating-count">(${car.avgRating.toFixed(1)}/5, ${car.reviewCount} reviews)</span>
                                </div>
                                <div class="user-info">
                                        <svg class="user-icon" viewBox="0 0 24 24" width="16" height="16">
                                            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                                        </svg>
                                    <span class="user-name">${car.ownerName}</span>
                                </div>
                                <div class="car-price-city">
                                    <span class="price">$${car.basePrice}/day</span>
                                    <span class="city">${car.city}</span>
                                </div>
                                     <button class="book-now-btn">Book Now</button>
                                </div>
                            `;
            card.innerHTML = carousel + carDetails;
            const bookNowButton = card.querySelector(".book-now-btn");
            bookNowButton.addEventListener("click", () => redirectToBookingPage(car.carId));
            return card;
        }

        async function renderCars() {
            const cars = await getCars();
            const carsContainer = document.getElementById("cars-container");
            carsContainer.innerHTML = "";
            cars.forEach((car) => {
                const card = createCarCard(car);
                carsContainer.appendChild(card);
            });
        }

        function prevImage(button) {
            const carousel = button.parentElement;
            const images = carousel.querySelectorAll(".carousel-image");
            let activeIndex = Array.from(images).findIndex((img) =>
                img.classList.contains("active")
            );

            images[activeIndex].classList.remove("active");
            activeIndex = (activeIndex - 1 + images.length) % images.length;
            images[activeIndex].classList.add("active");
        }

        function nextImage(button) {
            const carousel = button.parentElement;
            const images = carousel.querySelectorAll(".carousel-image");
            let activeIndex = Array.from(images).findIndex((img) =>
                img.classList.contains("active")
            );

            images[activeIndex].classList.remove("active");
            activeIndex = (activeIndex + 1) % images.length;
            images[activeIndex].classList.add("active");
        }

        document.addEventListener("DOMContentLoaded", renderCars);
    </script>
</body>

</html>
